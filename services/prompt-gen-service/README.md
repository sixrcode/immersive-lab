# Prompt Generation Microservice

This service is responsible for taking a user's prompt, an optional image, and an optional style preset, and generating a suite of creative assets for prototyping. This includes loglines, mood board concepts (textual descriptions and a generated image), shot lists, an animatic description, and a pitch summary.

It uses Express.js as the server framework and Genkit with Google AI for its core AI functionalities. Firebase Admin SDK is used for interacting with Firebase Storage to store generated images.

## Endpoints

-   `POST /generate`: The main endpoint that accepts a prompt and other parameters to generate prototype assets.
    -   **Request Body:** See `PromptToPrototypeInputSchema` in `prompt-to-prototype.flow.js`.
        ```json
        {
          "prompt": "A futuristic cityscape at dusk, with flying vehicles and neon signs.",
          "imageDataUri": "data:image/jpeg;base64,...", // Optional
          "stylePreset": "Cyberpunk" // Optional
        }
        ```
    -   **Response Body:** Returns a JSON object containing the generated assets, including URLs for any uploaded or generated images. See `PromptToPrototypeOutputSchema` in `prompt-to-prototype.flow.js` for the base structure, with image data URIs replaced by public URLs.

## Running Locally

1.  **Prerequisites:**
    *   Node.js (version specified in project's main `package.json` or `.nvmrc`)
    *   Access to a Firebase project with Firebase Storage enabled.
    *   A Google Cloud service account key JSON file with permissions for Firebase Storage and Google AI (e.g., Vertex AI User).

2.  **Setup:**
    *   Navigate to this directory: `cd services/prompt-gen-service`
    *   Install dependencies: `npm install`
    *   Set the required environment variables (see below).

3.  **Environment Variables:**

    Create a `.env` file in this directory (`services/prompt-gen-service/.env`) or set the variables in your shell environment:

    *   `GOOGLE_APPLICATION_CREDENTIALS`: **Required.** Path to your Firebase/Google Cloud service account key JSON file. This is used by the Firebase Admin SDK to interact with Firebase Storage and by the Genkit Google AI plugin for AI model access.
        ```
        GOOGLE_APPLICATION_CREDENTIALS=/path/to/your/serviceAccountKey.json
        ```

    *   `PORT`: **Optional.** The port on which the Express server should listen. If not set, it defaults to `8080`.
        ```
        PORT=8081
        ```
    *   `FIREBASE_STORAGE_BUCKET`: **Optional.** The name of the Firebase Storage bucket to use (e.g., `my-project.appspot.com`). If not explicitly set in `index.js` (currently it is not), the Firebase Admin SDK will attempt to use the default bucket associated with the service account. For most setups, this does not need to be set if the service account has a default project with Storage enabled.

4.  **Start the Service:**
    ```bash
    npm start
    ```
    (Assuming a `start` script like `"start": "node index.js"` is added to `services/prompt-gen-service/package.json`)

    If no `start` script, run:
    ```bash
    node index.js
    ```

## Firebase Storage

The service uploads two types of images to Firebase Storage:
1.  The original image provided by the user (if any), under `prototypes/<userId>/<promptPackageId>/user-upload-<uuid>.<ext>`.
2.  The AI-generated mood board image, under `prototypes/<userId>/<promptPackageId>/moodboard-<uuid>.<ext>`.

The `<userId>` is currently a placeholder ("microservice-user") and `<promptPackageId>` is a UUID generated by the calling API route.

The Firebase Storage bucket used is typically the default bucket associated with the Google Cloud project configured via `GOOGLE_APPLICATION_CREDENTIALS`. Ensure this bucket exists and the service account has write permissions.

## Genkit and Google AI

This service uses Genkit for its AI flow orchestration and the `@genkit-ai/googleai` plugin to interact with Google's generative models (e.g., Gemini). The `GOOGLE_APPLICATION_CREDENTIALS` are also used by this plugin to authorize API calls to Google AI services. Ensure the service account has the necessary IAM roles for Vertex AI or other Google AI model access.

## Deployment Considerations

This Express application is designed to be deployable as a standard Node.js service (e.g., to Cloud Run, or any platform that can run Node.js applications).

It also includes a Google Cloud Functions HTTP trigger (`promptGenServiceHttp` defined in `index.js`) for convenient deployment to Google Cloud Functions.

When deploying, ensure all necessary environment variables are correctly configured in your chosen deployment environment:
-   `GOOGLE_APPLICATION_CREDENTIALS`: Essential for Firebase Admin SDK and Genkit Google AI plugin functionality. For some environments (like Google Cloud Functions or Cloud Run with a service account attached), this might be automatically managed if the runtime service account has the correct permissions. Otherwise, you'll need to provide the path to the service account key file.
-   `FIREBASE_STORAGE_BUCKET`: If you are not using the default Firebase Storage bucket associated with your Google Cloud project, you must set this environment variable. The code currently relies on the default bucket if this variable is not explicitly handled in `index.js` for `admin.initializeApp`.
-   `PORT`: While Google Cloud Functions manages the port automatically, if deploying as a standalone Node.js service (e.g., in a container to Cloud Run), this variable will determine the port your application listens on (defaults to 8080).

Ensure the runtime service account (if applicable) or the provided service account key has appropriate permissions for:
-   Firebase Storage (read/write access to the target bucket).
-   Google AI services (e.g., Vertex AI User role for Gemini models).
