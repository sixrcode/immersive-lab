# Production Board API Documentation

This document outlines the API endpoints for the Production Board microservice.

## Authentication

All API endpoints require a valid authentication token (ID token) in the `Authorization` header: `Authorization: Bearer <TOKEN>`. These endpoints are defined within an Express application that is exported as a single Firebase Function, typically mapped under the `/api` path. For example, an endpoint described as `GET /production-board/columns` would be accessible at `YOUR_FUNCTION_URL/api/production-board/columns`.

## Data Models

### Column
Represents a stage in the production pipeline.
- `id` (string): Unique identifier for the column (auto-generated by Firestore).
- `title` (string): Name of the column.
- `cardOrder` (array of strings): Ordered list of card IDs belonging to this column.
- `cards` (array of Card objects): Full card objects. This field is dynamically populated when fetching columns via `GET /production-board/columns` and is not stored directly in the Column document in Firestore.
- `createdAt` (timestamp): Server timestamp of creation.
- `updatedAt` (timestamp): Server timestamp of last update.

### Card
Represents a task or item within a column.
- `id` (string): Unique identifier for the card (auto-generated by Firestore).
- `columnId` (string): ID of the column this card belongs to.
- `title` (string): Title of the card.
- `description` (string, optional): Detailed description of the card. Defaults to `null`.
- `priority` (string, optional): e.g., 'low', 'medium', 'high'. Defaults to `null`.
- `dueDate` (string, ISO Date format `YYYY-MM-DD`, optional): Due date for the card. Defaults to `null`.
- `coverImage` (string, URL, optional): URL for a cover image. Defaults to `null`.
- `dataAiHint` (string, optional): Hint for AI features. Defaults to `null`.
- `orderInColumn` (number): Zero-based index of the card within its column's visual representation (derived from `cardOrder` in the parent column).
- `createdAt` (timestamp): Server timestamp of creation.
- `updatedAt` (timestamp): Server timestamp of last update.

## API Endpoints

Base path for these endpoints: `/production-board` (relative to the main API function's path, e.g., `/api/production-board`)

### Columns

#### 1. GET /columns
- **Description:** Retrieves all production board columns, ordered by `createdAt` (ascending). Each column object will include an array of its associated card objects, ordered by their `orderInColumn`.
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** `[Column, ...]`
    ```json
    [
      {
        "id": "col1",
        "title": "To Do",
        "cardOrder": ["card1A", "card1B"],
        "createdAt": "2023-01-01T12:00:00Z",
        "updatedAt": "2023-01-01T12:05:00Z",
        "cards": [
          {
            "id": "card1A",
            "columnId": "col1",
            "title": "Task 1",
            "description": "Description for Task 1",
            "priority": "high",
            "dueDate": "2023-01-15",
            "coverImage": null,
            "dataAiHint": null,
            "orderInColumn": 0,
            "createdAt": "2023-01-01T12:01:00Z",
            "updatedAt": "2023-01-01T12:02:00Z"
          }
          // ... more cards in this column
        ]
      }
      // ... more columns
    ]
    ```
- **Error Responses:**
  - `500 Internal Server Error`: If there's an issue fetching data.
    ```json
    { "error": "Failed to fetch columns and their cards." }
    ```

#### 2. POST /columns
- **Description:** Creates a new column.
- **Request Body:**
  ```json
  {
    "title": "New Column Title"
  }
  ```
- **Success Response:**
  - **Code:** `201 Created`
  - **Body:** `Column` (the newly created column object, including its `id` and server-generated timestamps)
    ```json
    {
      "id": "colGeneratedId",
      "title": "New Column Title",
      "cardOrder": [],
      "createdAt": "2023-01-02T10:00:00Z",
      "updatedAt": "2023-01-02T10:00:00Z"
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If `title` is missing or an empty string.
    ```json
    { "error": "Title is required and must be a non-empty string." }
    ```
  - `500 Internal Server Error`: If creation fails.
    ```json
    { "error": "Failed to create new column." }
    ```

#### 3. PUT /columns/{columnId}
- **Description:** Updates the title of a specific column.
- **Path Parameters:**
  - `columnId` (string): The ID of the column to update.
- **Request Body:**
  ```json
  {
    "title": "Updated Column Title"
  }
  ```
  *Note: Only `title` can be updated. If `title` is not provided or is `undefined`, only `updatedAt` will be changed.*
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** `Column` (the updated column object)
    ```json
    {
      "id": "col1",
      "title": "Updated Column Title",
      "cardOrder": ["card1A"], // Existing cardOrder
      "createdAt": "2023-01-01T12:00:00Z",
      "updatedAt": "2023-01-02T11:00:00Z"
      // ... other fields
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If `columnId` is missing, or if `title` (when provided) is an empty string.
    ```json
    { "error": "Column ID is required." }
    // or
    { "error": "Title, if provided, must be a non-empty string." }
    ```
  - `404 Not Found`: If the column with the given `columnId` does not exist.
    ```json
    { "error": "Column not found." }
    ```
  - `500 Internal Server Error`: If the update fails.
    ```json
    { "error": "Failed to update column." }
    ```

#### 4. DELETE /columns/{columnId}
- **Description:** Deletes a specific column and all cards associated with it.
- **Path Parameters:**
  - `columnId` (string): The ID of the column to delete.
- **Success Response:**
  - **Code:** `204 No Content`
- **Error Responses:**
  - `400 Bad Request`: If `columnId` is missing.
    ```json
    { "error": "Column ID is required." }
    ```
  - `404 Not Found`: If the column with the given `columnId` does not exist.
    ```json
    { "error": "Column not found." }
    ```
  - `500 Internal Server Error`: If deletion fails.
    ```json
    { "error": "Failed to delete column and its cards." }
    ```

### Cards

#### 5. POST /columns/{columnId}/cards
- **Description:** Creates a new card in the specified column. The card's ID will be added to the column's `cardOrder` array.
- **Path Parameters:**
  - `columnId` (string): The ID of the column where the card should be created.
- **Request Body:**
  ```json
  {
    "title": "New Card Title",
    "description": "Optional detailed description for the card.",
    "priority": "medium", // optional: 'low', 'medium', 'high'
    "dueDate": "2023-02-28", // optional: YYYY-MM-DD
    "coverImage": "https://example.com/image.png", // optional
    "dataAiHint": "AI hint text", // optional
    "orderInColumn": 0 // Optional: Zero-based index for card placement in cardOrder. Appends if omitted or invalid.
  }
  ```
- **Success Response:**
  - **Code:** `201 Created`
  - **Body:** `Card` (the newly created card object, including its `id`, `columnId`, and server-generated timestamps)
    ```json
    {
      "id": "cardGeneratedId",
      "columnId": "col1",
      "title": "New Card Title",
      "description": "Optional detailed description for the card.",
      "priority": "medium",
      "dueDate": "2023-02-28",
      "coverImage": "https://example.com/image.png",
      "dataAiHint": "AI hint text",
      "orderInColumn": 0,
      "createdAt": "2023-01-02T12:00:00Z",
      "updatedAt": "2023-01-02T12:00:00Z"
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If `columnId` in path is missing, or if `title` in body is missing/empty.
    ```json
    { "error": "Column ID is required." }
    // or
    { "error": "Card title is required and must be a non-empty string." }
    ```
  - `404 Not Found`: If the `columnId` specified in the path does not exist.
    ```json
    { "error": "Column not found." }
    ```
  - `500 Internal Server Error`: If creation fails (e.g., transaction error).
    ```json
    { "error": "Failed to create new card." }
    ```

#### 6. GET /cards/{cardId}
- **Description:** Retrieves a specific card by its ID.
- **Path Parameters:**
  - `cardId` (string): The ID of the card to retrieve.
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** `Card`
    ```json
    {
      "id": "card1A",
      "columnId": "col1",
      "title": "Task 1",
      // ... all other card fields
      "createdAt": "2023-01-01T12:01:00Z",
      "updatedAt": "2023-01-01T12:02:00Z"
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If `cardId` is missing.
    ```json
    { "error": "Card ID is required." }
    ```
  - `404 Not Found`: If the card with the given `cardId` does not exist.
    ```json
    { "error": "Card not found." }
    ```
  - `500 Internal Server Error`: If fetching fails.
    ```json
    { "error": "Failed to fetch card." }
    ```

#### 7. PUT /cards/{cardId}
- **Description:** Updates details of a specific card. Only provided fields are updated. `columnId` cannot be changed with this endpoint; use the move endpoint for that.
- **Path Parameters:**
  - `cardId` (string): The ID of the card to update.
- **Request Body (example with optional fields):**
  ```json
  {
    "title": "Updated Card Title",
    "description": "New updated description.",
    "priority": "high",
    "dueDate": "2023-03-15",
    "orderInColumn": 1 // Note: This updates the card's field, but doesn't by itself reorder `cardOrder` in the column. Use PATCH /move for full reordering.
  }
  ```
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** `Card` (the updated card object)
- **Error Responses:**
  - `400 Bad Request`: If `cardId` is missing, no valid fields provided, or `title` (if provided) is empty.
    ```json
    { "error": "Card ID is required." }
    // or
    { "error": "No valid fields provided for update." }
    // or
    { "error": "Title, if provided, must be a non-empty string." }
    ```
  - `404 Not Found`: If the card with the given `cardId` does not exist.
    ```json
    { "error": "Card not found." }
    ```
  - `500 Internal Server Error`: If update fails.
    ```json
    { "error": "Failed to update card." }
    ```

#### 8. DELETE /cards/{cardId}
- **Description:** Deletes a specific card. The card's ID will also be removed from its parent column's `cardOrder` array.
- **Path Parameters:**
  - `cardId` (string): The ID of the card to delete.
- **Success Response:**
  - **Code:** `204 No Content`
- **Error Responses:**
  - `400 Bad Request`: If `cardId` is missing.
    ```json
    { "error": "Card ID is required." }
    ```
  - `404 Not Found`: If the card with the given `cardId` does not exist.
    ```json
    { "error": "Card not found." }
    ```
  - `500 Internal Server Error`: If deletion fails (e.g., transaction error).
    ```json
    { "error": "Failed to delete card." }
    ```

#### 9. PATCH /cards/{cardId}/move
- **Description:** Moves a card to a new column and/or a new position within a column's `cardOrder`. This involves updating the card's `columnId` and `orderInColumn` fields, and also modifying the `cardOrder` arrays of the source and target columns.
- **Path Parameters:**
  - `cardId` (string): The ID of the card to move.
- **Request Body:**
  ```json
  {
    "targetColumnId": "newColId",      // ID of the column to move the card to.
    "newOrderInColumn": 1             // Zero-based index in the target column's cardOrder array.
                                     // If out of bounds or not provided, card is typically appended.
  }
  ```
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** `Card` (the updated card object, reflecting its new `columnId` and `orderInColumn`)
    ```json
    {
      "id": "card1",
      "columnId": "newColId",
      "title": "Card Title",
      "orderInColumn": 1,
      // ... other card fields
      "updatedAt": "2023-01-02T15:00:00Z"
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If `cardId` in path is missing, or `targetColumnId` in body is missing. Or if `newOrderInColumn` is invalid (e.g., negative).
    ```json
    { "error": "Card ID is required." }
    // or
    { "error": "Target column ID is required." }
    // or
    { "error": "New order index must be a non-negative number." }
    ```
  - `404 Not Found`: If `cardId` (card to move) or `targetColumnId` (destination column) does not exist.
    ```json
    { "error": "Card not found." }
    // or
    { "error": "Target column {targetColumnId} not found." }
    ```
  - `500 Internal Server Error`: If the move operation fails (e.g., transaction error).
    ```json
    { "error": "Failed to move card." }
    ```

## AI-Powered Checklist Generation

Base path for this endpoint: `/api` (relative to the AI microservice function's URL, e.g., `YOUR_AI_FUNCTION_URL/api`)

### 1. POST /productionChecklist
- **Description:** Generates a production checklist based on script analysis output and specified requirements.
- **Authentication:** Requires a valid authentication token (ID token) in the `Authorization` header: `Authorization: Bearer <TOKEN>`.
- **Request Body:**
  ```json
  {
    "scriptAnalysis": {
      "analysis": "SCENE 1: INT. COFFEE SHOP - DAY. ANNA (30s) sits by the window, sipping coffee and writing in a RED NOTEBOOK. MARK (30s) enters and approaches her. Anna wears a BLUE DRESS. Mark needs a FAKE BEARD for a later scene.",
      "suggestions": [
        {
          "section": "ANNA (30s) sits by the window",
          "issue": "Age ambiguity",
          "improvement": "Specify if '30s' means early, mid, or late thirties for better casting."
        }
      ]
    },
    "checklistRequirements": {
      "include": ["casting", "locations", "props", "wardrobe", "makeup"]
    }
  }
  ```
  - `scriptAnalysis` (object, required): The output from the Script Analyzer service.
    - `analysis` (string, required): The main textual analysis of the script.
    - `suggestions` (array of objects, optional): A list of suggestions, each with `section`, `issue`, and `improvement`.
  - `checklistRequirements` (object, required): Specifies which categories of tasks to generate.
    - `include` (array of strings, required): An array of task categories. Possible values include: "casting", "locations", "props", "wardrobe", "makeup", "sfx", "vfx", "stunts", "music", "setDressing", "animals", "unknown".
- **Success Response:**
  - **Code:** `200 OK`
  - **Body:** An object containing the generated checklist package.
    ```json
    {
      "id": "checklistGeneratedId",
      "userId": "userFirebaseUid",
      "createdAt": "2023-10-27T10:00:00Z",
      "scriptAnalysisId": "scriptAnalysisOptionalId", // ID of the source scriptAnalysis, if available
      "checklistRequirements": {
        "include": ["casting", "locations", "props", "wardrobe", "makeup"]
      },
      "tasks": [
        {
          "id": "task-001",
          "type": "casting",
          "description": "Cast character: ANNA",
          "sceneContext": "SCENE 1: INT. COFFEE SHOP - DAY",
          "notes": "Character is in their 30s. Wears a BLUE DRESS."
        },
        {
          "id": "task-002",
          "type": "casting",
          "description": "Cast character: MARK",
          "sceneContext": "SCENE 1: INT. COFFEE SHOP - DAY",
          "notes": "Character is in their 30s. Requires a FAKE BEARD for a later scene."
        },
        {
          "id": "task-003",
          "type": "locations",
          "description": "Secure location: INT. COFFEE SHOP - DAY",
          "sceneContext": "SCENE 1"
        },
        {
          "id": "task-004",
          "type": "props",
          "description": "Acquire prop: RED NOTEBOOK",
          "sceneContext": "SCENE 1: INT. COFFEE SHOP - DAY"
        },
        {
          "id": "task-005",
          "type": "wardrobe",
          "description": "Prepare wardrobe: BLUE DRESS for ANNA",
          "sceneContext": "SCENE 1: INT. COFFEE SHOP - DAY"
        },
        {
          "id": "task-006",
          "type": "makeup",
          "description": "Prepare makeup: FAKE BEARD for MARK",
          "sceneContext": "SCENE 1 (mentioned for later scene)"
        }
      ]
    }
    ```
- **Error Responses:**
  - `400 Bad Request`: If the input validation fails (e.g., missing `scriptAnalysis` or `checklistRequirements`).
    ```json
    {
      "success": false,
      "error": {
        "id": "errorGeneratedId",
        "message": "Invalid input for production checklist",
        "code": "VALIDATION_ERROR",
        "details": { /* Zod error formatting */ }
      }
    }
    ```
  - `500 Internal Server Error`: If the checklist generation or database operation fails.
    ```json
    {
      "success": false,
      "error": {
        "id": "errorGeneratedId",
        "message": "An unexpected error occurred.",
        "code": "INTERNAL_ERROR"
      }
    }
    ```
